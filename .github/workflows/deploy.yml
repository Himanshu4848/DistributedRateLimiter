name: Deploy Rate Limiter Manually

# Manual trigger
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout selected branch
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      # Step 2: Set up Java 17
      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Make mvnw executable
        run: chmod +x ./mvnw

      # Step 3: Build project
      - name: Build project
        run: ./mvnw clean package

      # Step 4: Copy JAR to EC2
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          source: target/distributed-rate-limiter-*.jar   # â† use wildcard
          target: /home/ec2-user/rate-limiter/
          port: 22

      # Step 5: Restart service on EC2 (fixed)
      - name: Restart service on EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            # Kill previous JAR if running
            pkill -f distributed-rate-limiter-*.jar || true

            # Start new JAR in background
            nohup java -jar /home/ec2-user/rate-limiter/distributed-rate-limiter-*.jar \
            > /home/ec2-user/rate-limiter/service.log 2>&1 &
